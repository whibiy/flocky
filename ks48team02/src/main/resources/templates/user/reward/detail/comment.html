<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/reward/detail/default}">

<head>
    <!--  ì‚¬ìš©ìë³„ css file ì¶”ê°€ ë¶€ë¶„ -->
    <title th:text="${title}"></title>
    <style>
        #commentBox {
            display: none;
            position: fixed;
            top: 0; left: 0;
            z-index: 99999;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.2);
        }
        .comment-box-content {
            padding-left: 20px;
            padding-right: 20px;
            padding-top: 15px;
            padding-bottom: 10px;
            width: 550px;
            height: 520px;
            background: #fff;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 20px;
        }
        /*ë²„íŠ¼ ëˆŒë¦¬ëŠ” íš¨ê³¼*/
        #commentBtn:active, #commentAddBtn:active{
            box-shadow: inset -.3rem -.1rem 1.4rem  #FBFBFB, inset .3rem .4rem .8rem #BEC5D0;
            cursor: pointer;
        }
        #commentBtn, #commentAddBtn{
            /* ìƒì ë””ìì¸ í°í‹€*/
            padding: 10px;
            border: 0px;
            background-color: #E4EBF5;

            /* ê·¸ë¦¼ì */
            border-radius: 5px;
            box-shadow:.5rem .3rem 1.4rem  #BEC5D0, -.1rem -.2rem .8rem #FBFBFB;
            /* box-shadow:-.2rem -.2rem 1.8rem white, .8rem .8rem 1.4rem  #AAB7CB; */

            /* ê¸€ì”¨ */
            color: #333333;
            font-weight: bold;

            animation-name: keybtn-language;
            animation-duration: .2s;
        }
        .comments-reply{
            display: none;
        }
        .reward-comments{
            color: black;
            white-space: pre-line;
            overflow: hidden;
            font-size: 13px;
            text-align: left;
            padding-left: 5px;
        }

    </style>
</head>


<!-- ì‚¬ìš©ì í˜ì´ì§€ë³„ javascript file -->
<th:block layout:fragment="customJsFile">
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
</th:block>

<!-- ì‚¬ìš©ìë³„ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± -->
<th:block layout:fragment="customJsCode">

    <script th:inline="javascript">

        //í˜„ì¬ ë¡œê·¸ì¸ í•œ ì•„ì´ë””
        const  loginMemberId = [[${memberId}]];

        var swiper = new Swiper(".mySwiper", {
            spaceBetween: 30,    // ìŠ¬ë¼ì´ë“œ ì‚¬ì´ ì—¬ë°±
            slidesPerView : 'auto', // í•œ ìŠ¬ë¼ì´ë“œì— ë³´ì—¬ì¤„ ê°¯ìˆ˜
            centeredSlides: true,    //ì„¼í„°ëª¨ë“œ
            autoplay: {     //ìë™ìŠ¬ë¼ì´ë“œ (false-ë¹„í™œì„±í™”)
                delay: 2500, // ì‹œê°„ ì„¤ì •
                disableOnInteraction: false, // false-ìŠ¤ì™€ì´í”„ í›„ ìë™ ì¬ìƒ
            },
            loop : false,   // ìŠ¬ë¼ì´ë“œ ë°˜ë³µ ì—¬ë¶€
            loopAdditionalSlides : 1,
            // ìŠ¬ë¼ì´ë“œ ë°˜ë³µ ì‹œ ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œì—ì„œ ë‹¤ìŒ ìŠ¬ë¼ì´ë“œê°€ ë³´ì—¬ì§€ì§€ ì•ŠëŠ” í˜„ìƒ ìˆ˜ì •
            pagination: { // í˜¸ì¶œ(pager) ì—¬ë¶€
                el: ".swiper-pagination", //ë²„íŠ¼ì„ ë‹´ì„ íƒœê·¸ ì„¤ì •
                clickable: true, // ë²„íŠ¼ í´ë¦­ ì—¬ë¶€
            },
            navigation: {   // ë²„íŠ¼
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
        });
        let rewardProjectSwiperSlide = new Swiper("#rewardProject .contents-area", {
            slidesPerView: 3,
            spaceBetween: 12,
            navigation: {
                nextEl: "#rewardProject .swiper-button-next",
                prevEl: "#rewardProject .swiper-button-prev",
            },
        });

        const $writeButton = document.getElementById('commentBtn');
        const $commentBox = document.getElementById('commentBox');
        const $commentBoxClose = document.getElementById('commentBoxClose');

        $writeButton.addEventListener('click', function (){

            if (loginMemberId == '' || loginMemberId == null || typeof loginMemberId == 'undefined'){
                alert('ê¸€ì“°ê¸° ê¸°ëŠ¥ì€ ë¡œê·¸ì¸ì„ í•´ì•¼í•©ë‹ˆë‹¤!');
                return false;
            }else{
                $commentBox.style.display = 'block'; // ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ“ê¸€ ì°½ ì—´ë¦¼
            }

        });

        $commentBoxClose.addEventListener('click', function (){
            $commentBox.style.display = 'none'; // ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ“ê¸€ ì°½ ì¢…ë£Œ
        });

        $('.comment-text-box').keyup(function (e){
            const content = $(this).val();
            if(content.length > 10){
                $('#commentCounter').html("("+content.length+" / ìµœëŒ€ 2000ì ê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.)");
            }else{
                $('#commentCounter').html("("+content.length+" / ìµœì†Œ 10ê¸€ì ì´ìƒë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.)");
            }
        });

        $('.reply').on('click', function (){



            const $replyArrow = $(this).find('.replyArrow');
            const $commentsReply = $(this).siblings('.comments-reply');

            if ($replyArrow.text() == 'â–½') {
                $replyArrow.text("â–³");
                $commentsReply.css('display', 'inline-block');
            } else {
                $replyArrow.text("â–½");
                $commentsReply.css('display', 'none');
            }

            $('.replyArrow').not($(this).find('.replyArrow')).text("â–½");
            $('.comments-reply').not($(this).siblings('.comments-reply')).css('display', 'none');

        });






        // í˜„ì¬ í”„ë¡œì íŠ¸ì½”ë“œë¡œ ìƒì„¸í˜ì´ì§€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ì½”ë“œ
        let rewardProjectCode = '[[${rewardProject.rewardProjectCode}]]';
        // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ê²½ë¡œ ì§€ì •
        let thumbNailImageSrc = $('#thumbNailImage').attr('src');
        $('#thumbNailImage').attr('src', '/summernoteImage/' + '[[${rewardProject.projectThumbnailImage}]]');

        // ìŠ¤í† ë¦¬ì—ì„œ ì•ì— ë¶€ë¶„ë§Œ ì˜ë¼ì„œ ê³µë°±í¬í•¨ 155ê¸€ìë§Œ ê°€ì ¸ì˜´ ê·¸ë’¤ëŠ” ... ìœ¼ë¡œ ë‹¤ìë¦„
        let storyBodyText = $('#storyBody').children('p:eq(0)').text();
        $('#subContens').text(storyBodyText);
        if (storyBodyText.length > 155) {
            storyBodyText = storyBodyText.substring(0, 155) + '...';
        }
        // ê°€ì ¸ì˜¨ í…ìŠ¤íŠ¸ë¥¼ subContensì— ì„¤ì •
        $('#subContens').text(storyBodyText);

        let currentDate = new Date();
        // ë¹„êµ ëŒ€ìƒ ë‚ ì§œ ì„¤ì •
        let targetDate = new Date($('#projectEndDate').val());
        // ë‘ ë‚ ì§œ ê°„ì˜ ì°¨ì´ ê³„ì‚° (ë°€ë¦¬ì´ˆ ë‹¨ìœ„)
        let timeDifference = targetDate - currentDate;
        // ì°¨ì´ë¥¼ ì¼(day) ë‹¨ìœ„ë¡œ ë³€í™˜
        let daysRemaining = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
        // ë‚¨ì€ ì¼ ìˆ˜
        $('#deadLine').text(daysRemaining + 'ì¼ë‚¨ìŒ');

        // ë‹¬ì„± ê¸ˆì•¡ ì„¤ì •
        $('#achievementMoney').text(`[[${rewardProject.projectAchievementMoney}]]`.replace(/\B(?=(\d{3})+(?!\d))/g, ","))

        $('#commentAddBtn').click(function (){
            if($('.comment-text-box').val().length < 10){
                alert('10ê¸€ì ì´ìƒë§Œ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!');
                return false;
            }else{
                $('#commentAddForm').submit();
            }
            //
        });

        $('.replyBtn').click(function (){

            if (loginMemberId == '' || loginMemberId == null || typeof loginMemberId == 'undefined'){
                alert('ê¸€ì“°ê¸° ê¸°ëŠ¥ì€ ë¡œê·¸ì¸ì„ í•´ì•¼í•©ë‹ˆë‹¤!');
                return false;
            }else{
                const parentCommentCode = $(this).next().val();
                const reply = $(this).prev().val();
                const rewardProjectCode = [[${rewardProject.rewardProjectCode}]];

                if (reply.length < 5) {
                    alert('ë‹¤ì„¯ê¸€ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                    return false;
                }


                $.ajax({
                    type: "post",
                    url: "/user/reward/detail/reply",
                    data: {
                        parentCommentCode : parentCommentCode,
                        reply : reply,
                        rewardProjectCode : rewardProjectCode},
                    success: function (){
                        console.log("ajxaì„±ê³µ");
                    },
                    error:function (){
                        console.log("ajaxì‹¤íŒ¨");
                    }
                });
                location.reload();
            }
        });

        const replyArr = [];
        $('.replyCnt').each(function (index) {
            if (index !== 0) { // ì²« ë²ˆì§¸ ìš”ì†Œê°€ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
                replyArr.push($(this).text());
            }
        });

        $('.comment-count').each(function (idx){
            $(this).text(replyArr[idx]);
        });
    </script>

</th:block>


<!--/* layout:decorate : íŒŒì¼ì—ì„œ ì‚¬ìš©ì ì •ì˜ë¡œ ì„ ì–¸í•œ ì¡°ê°ì— ì‘ì„±í•œ html ì½”ë“œ ì‚½ì… */-->
<th:block layout:fragment="customContents">
    <div class="col-lg-12" style="height: 40px"></div>
    <div class="container">
        <div>
            <div class="col-lg-12">
                <br>
                <span style="font-weight: bold; font-size: 20px; color: black">ëŒ“ê¸€</span>
                <span id="reviewSize" style="color: #235FD9; font-weight: bold; margin-left: 5px;" th:text="${#lists.size(rewardCommentList)}"></span>
                <span style="float: right">
                    <button id="commentBtn" type="button" style="background: #235FD9; width: 100%; height: 40px; color: white; font-size: 15px; outline-color: #235FD9; outline-width: 1px">ëŒ“ê¸€ ì“°ê¸°</button>
                </span>
            </div>
        </div>
    </div>
    <div style="border: 0.3px solid #f3f4f5; margin: 10px 0px; width: 100%"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-12 comments-review my-lg-3"  th:each="l : ${rewardCommentList}">
                <div class="user-comments-profile">
                    <div style="display: inline-block;">
                        <img src="https://picpac.kr/common/img/default_profile.png" style="width: 50px; height: 50px; border-radius: 30px;">
                    </div>
                    <div style="display: inline; width: auto; height: 100%; color: black; font-weight: bold; margin-left: 5px; top: 10%">
                        <span  th:text="${l.memberId}"></span>
                        <span class="float-right">
                            <a th:if="${memberId == l.memberId}" onclick='return confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");' class="delCommentBtn btn btn-sm btn-danger btn rounded-pill justify-content-end" th:href="@{/user/reward/detail/commentDelete(rewardProjectCode=${rewardProject.rewardProjectCode},rewardCommentCode=${l.rewardCommentCode})}">ì‚­ì œ</a>
                        </span>
                    </div>
                </div>
                <div class="col-lg-12" style="height: 10px"></div>
                <div style="background: #f9fafb; border-radius: 5px; padding: 10px" class=" mb-lg-2">
                    <div >
                        <div class="reward-comments" th:text="${l.commentContent}"></div>
                    </div>
                </div>
                <div class="reply" style="display: inline-block; cursor: pointer">
                    <span>ğŸ’¬</span>
                    <span class="comment-count" th:text="${#lists.size(l.rewardReplyList)}"></span>
                    <span class="replyArrow" style="margin-left: 3px">â–½</span><span></span>
                </div>
                <div class="comments-reply" style="width: 100%">
                    <div style="display: flex; margin-bottom: 10px">
                        <form id="replyForm" th:action="@{/user/reward/detail/reply}" method="post"> <!-- form ë°˜ë³µë¬¸ í•´ê²°-->
                            <div style="display: inline-block; top: 0; margin-right: 5px; margin-bottom: 5px;">
                                <img src="https://picpac.kr/common/img/default_profile.png" style="width: 40px; height: 40px; border-radius: 30px;">
                                <span th:text="${memberId}" style="color: black; margin-left: 5px; font-weight: bold"></span>
                            </div>
                            <div style="display: flex">
                                <textarea class="replyContents" style="width: 540px; height: 60px; resize: none; outline-color: #235FD9; outline-width: 1px; padding: 10px;" minlength="10" maxlength="200" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"></textarea>
                                <button class="replyBtn btn btn-primary my-2" type="button" style="background-color: #235FD9; margin-left: 5px; width: 60px">ì…ë ¥</button>
                                <input class="parentCommentCode" hidden="hidden" th:value="${l.rewardCommentCode}">
                                <input class="rewardProjectCode" hidden="hidden" th:value="${l.rewardProjectCode}">
                            </div>
                        </form>
                    </div>
                    <div class="replyContents" style="display: flex; margin-bottom: 15px" th:if="${#lists.size(rl) > 0}" th:each="rl : ${l.rewardReplyList}">
                        <div style="top: 0; margin-right: 5px;">
                            <img src="https://picpac.kr/common/img/default_profile.png" style="width: 40px; height: 40px; border-radius: 30px;">
                        </div>
                        <div  style="background: #f9fafb; border-radius: 5px; padding: 10px; width: 100%">
                            <div>
                                <div class="replyMemberId" style="font-weight: bold; color: black;" th:text="${rl.memberId}"></div>
                                <span th:text="${rl.commentContent}"></span>
                                <span style="float: right">
                                    <a th:if="${memberId == rl.memberId}" onclick='return confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");' class="delReplyBtn btn-sm btn-danger btn rounded-pill" th:href="@{/user/reward/detail/commentDelete(rewardProjectCode=${rewardProject.rewardProjectCode},rewardCommentCode=${rl.rewardCommentCode})}">ì‚­ì œ</a>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>

            </div>
            <div class="col-lg-12" style="height: 20px"></div>
        </div>

    </div>



    <!-- popup -->
    <div id="commentBox">
        <div class="comment-box-content">
            <form id="commentAddForm" th:action="@{/user/reward/detail/comment}" method="post">
                <div style="display: inline-block; font-size: 25px; color: black; font-weight: bold; margin-top: 10px;">ì‘ì›</div>
                <div id="commentBoxClose" style="display: inline-block; float: right; font-size: 30px; cursor: pointer">
                    â¨‰
                </div>
                <div style="margin-top: 10px">
                    <textarea name="commentContent" class="comment-text-box" style="width: 100%; height: 200px; resize: none; outline-color: #235FD9; outline-width: 1px; padding: 10px;" minlength="10" maxlength="2000" placeholder="ì‘ì›ì˜ ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"></textarea>
                </div>
                <span id="commentCounter" style="color: black">(0 / ìµœì†Œ 10ê¸€ì ì´ìƒë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.)</span>
                <div style="background: #fff1f1; border-radius: 5px; padding: 20px; font-size: 12px">
                    <p>
                        âš ï¸ìµœê·¼ ë©”ì´ì»¤ ë˜ëŠ” ì œ3ìì— ëŒ€í•œ í—ˆìœ„ì‚¬ì‹¤ ìœ í¬, ë¹„ë°© ëª©ì ì˜ ëŒ“ê¸€ë¡œ ì¸í•´ ë‹¹ì‚¬ìê°„ ë²•ì ë¶„ìŸì´ ë°œìƒí•œ ì‚¬ë¡€ê°€ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                        ì•…ì˜ì  ëŒ“ê¸€ ì‘ì„±ìëŠ” ëª…ì˜ˆí›¼ì†, ëª¨ìš• ë“±ìœ¼ë¡œ ë²•ì  ì±…ì„ì„ ë¶€ë‹´í•˜ê²Œ ë  ìˆ˜ ìˆë‹¤ëŠ” ì ì„ ìœ ì˜í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                    </p>
                </div>
                <div style="margin-top: 10px">
                    <button id="commentAddBtn" type="button" style="background: #235FD9; width: 100%; height: 40px; color: white; font-size: 15px; outline-color: #235FD9; outline-width: 1px">ê¸€ì“°ê¸°</button>
                </div>
                <input hidden="hidden" name="rewardProjectCode" th:value="${rewardProject.rewardProjectCode}">
            </form>
        </div>
        <!-- ë¶€ê°€ì„¤ëª…ì„ ìœ„í•œ ë°ì´í„° -->
        <div hidden="hidden" id="storyBody" th:utext="${rewardProject.projectContents}" style="color: black; white-space: pre-line"></div>
    </div>

</th:block>

</html>

